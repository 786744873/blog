---
title: MyBatis的工作原理以及核心流程介绍
date: 2021-08-22
sidebar: auto
categories:
 - mybatis
tags:
 - mybatis core
---

## 概述✨

**MyBatis的底层操作封装了JDBC的API，MyBatis的工作原理以及核心流程与JDBC的使用步骤一脉相承，MyBatis的核心对象（SqlSession，Executor）与JDBC的核心对象(Connection，Statement）相互对应。从JDBC入手并立足于JDBC，才能深入的理解MyBatis的工作原理以及核心流程。**

## 核心对象✔

### JDBC有四个核心对象👀

```markdown
（1）DriverManager，用于注册数据库连接
（2）Connection，与数据库连接对象
（3）Statement/PrepareStatement，操作数据库SQL语句的对象
（4）ResultSet，结果集或一张虚拟表
```
### MyBatis也有四大核心对象👀
```markdown
（1）SqlSession对象，该对象中包含了执行SQL语句的所有方法【1】。类似于JDBC里面的Connection 【2】。
（2）Executor接口，它将根据SqlSession传递的参数动态地生成需要执行的SQL语句，同时负责查询缓存的维护。类似于JDBC里面的Statement/PrepareStatement。
（3）MappedStatement对象，该对象是对映射SQL的封装，用于存储要映射的SQL语句的id、参数等信息。
（4）ResultHandler对象，用于对返回的结果进行处理，最终得到自己想要的数据格式或类型。可以自定义返回类型。
```
::: tip 备注【1】和备注【1】的说明如下
```markdown
在JDBC中，Connection不直接执行SQL方法，而是利用Statement或者PrepareStatement来执行方法。

在使用JDBC建立了连接之后，可以使用 Connection接口的 createStatement() 方法来获取 Statement 对象，也可以调用

prepareStatement() 方法获得 PrepareStatement 对象，通过 executeUpdate() 方法来执行SQL语句。

而在 MyBatis 中，SqlSession对象包含了执行SQL语句的所有方法。但是它是委托 Executor 执行的。 
从某种意义上来看，MyBatis里面的 SqlSession 类似于JDBC中的 Connection，他们都是委托给其他类去执行。 

最后说一点，虽然SqlSession对象包含了执行SQL语句的所有方法，但是它同样包括了：
<T> getMapper(Class<T> type);

所以SqlSession也可以委托给映射器来执行数据的增删改查操作。如下代码所示：
获得mapper接口的代理对象:PersonMapper pm = session.getMapper(PersonMapper.class);
直接调用接口的方法，查询id为1的Peson数据:Person p2 = pm.selectPersonById(1)
```
:::
## MyBatis的工作原理以及核心流程详解

### MyBatis的工作原理如下图所示💦

<p>
<img :src="$withBase('/mybatis/mybatis082201_1.png')" alt="mybatis082201_1" class="medium-zoom-image">
</p>

## 详细说明⏬
```markdown
（1）读取MyBatis的配置文件。mybatis-config.xml为MyBatis的全局配置文件，用于配置数据库连接信息。

（2）加载映射文件。映射文件即SQL映射文件，该文件中配置了操作数据库的SQL语句，需要在MyBatis配置文件mybatis-config.xml中加载。mybatis-config.xml 文件可以加载多个映射文件，每个文件对应数据库中的一张表。

（3）构造会话工厂。通过MyBatis的环境配置信息构建会话工厂SqlSessionFactory。

（4）创建会话对象。由会话工厂创建SqlSession对象，该对象中包含了执行SQL语句的所有方法。

（5）Executor执行器。MyBatis底层定义了一个Executor接口来操作数据库，它将根据SqlSession传递的参数动态地生成需要执行的SQL语句，同时负责查询缓存的维护。

（6）MappedStatement对象。在Executor接口的执行方法中有一个MappedStatement类型的参数，该参数是对映射信息的封装，用于存储要映射的SQL语句的id、参数等信息。

（7）输入参数映射。输入参数类型可以是Map、List等集合类型，也可以是基本数据类型和POJO类型。输入参数映射过程类似于JDBC对preparedStatement对象设置参数的过程。

（8）输出结果映射。输出结果类型可以是Map、List等集合类型，也可以是基本数据类型和POJO类型。输出结果映射过程类似于JDBC对结果集的解析过程。
```
## 总结✅
> **mybatis应用程序通过SqlSessionFactoryBuilder从mybatis-config.xml配置文件中构建出SqlSessionFactory，然后，SqlSessionFactory的实例直接开启一个SqlSession，再通过SqlSession实例获得Mapper对象并运行Mapper映射的SQL语句，完成对数据库的CRUD和事务提交，之后关闭SqlSession。**

## 图示💨
<p>
<img :src="$withBase('/mybatis/mybatis082201_2.png')" alt="mybatis082201_2" class="medium-zoom-image">
</p>
